{"version":3,"sources":["message_composer.js"],"names":[],"mappings":"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","file":"message_composer-compiled.js","sourcesContent":["/*!\n * Webogram v0.5.5 - messaging web application for MTProto\n * https://github.com/zhukov/webogram\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\n * https://github.com/zhukov/webogram/blob/master/LICENSE\n */\n\n'use strict'\n\n/* EmojiHelper */\n\n;(function (global, emojis, categories, spritesheets) {\n  var emojis = {}\n  var shortcuts = {}\n  var spritesheetPositions = {}\n  var index = false\n\n  var popular = 'joy,kissing_heart,heart,heart_eyes,blush,grin,+1,relaxed,pensive,smile,sob,kiss,unamused,flushed,stuck_out_tongue_winking_eye,see_no_evil,wink,smiley,cry,stuck_out_tongue_closed_eyes,scream,rage,smirk,disappointed,sweat_smile,kissing_closed_eyes,speak_no_evil,relieved,grinning,yum,laughing,ok_hand,neutral_face,confused'.split(',')\n\n  var i\n  var j\n  var code\n  var shortcut\n  var emoji\n  var row\n  var column\n  var totalColumns\n  var len1\n  var len2\n\n  for (i = 0, len1 = categories.length; i < len1; i++) {\n    totalColumns = spritesheets[i][1]\n    for (j = 0, len2 = categories[i].length; j < len2; j++) {\n      code = categories[i][j]\n      emoji = Config.Emoji[code]\n      shortcut = emoji[1][0]\n      emojis[code] = [emoji[0], shortcut]\n      shortcuts[shortcut] = code\n      spritesheetPositions[code] = [i, j, Math.floor(j / totalColumns), j % totalColumns]\n    }\n  }\n\n  function getPopularEmoji (callback) {\n    ConfigStorage.get('emojis_popular', function (popEmojis) {\n      var result = []\n      if (popEmojis && popEmojis.length) {\n        for (var i = 0, len = popEmojis.length; i < len; i++) {\n          result.push({code: popEmojis[i][0], rate: popEmojis[i][1]})\n        }\n        callback(result)\n        return\n      }\n      ConfigStorage.get('emojis_recent', function (recentEmojis) {\n        recentEmojis = recentEmojis || popular || []\n        var shortcut\n        var code\n        for (var i = 0, len = recentEmojis.length; i < len; i++) {\n          shortcut = recentEmojis[i]\n          if (Array.isArray(shortcut)) {\n            shortcut = shortcut[0]\n          }\n          if (shortcut && typeof shortcut === 'string') {\n            if (shortcut.charAt(0) == ':') {\n              shortcut = shortcut.substr(1, shortcut.length - 2)\n            }\n            if (code = shortcuts[shortcut]) {\n              result.push({code: code, rate: 1})\n            }\n          }\n        }\n        callback(result)\n      })\n    })\n  }\n\n  function pushPopularEmoji (code) {\n    getPopularEmoji(function (popularEmoji) {\n      var exists = false\n      var count = popularEmoji.length\n      var result = []\n      for (var i = 0; i < count; i++) {\n        if (popularEmoji[i].code == code) {\n          exists = true\n          popularEmoji[i].rate++\n        }\n        result.push([popularEmoji[i].code, popularEmoji[i].rate])\n      }\n      if (exists) {\n        result.sort(function (a, b) {\n          return b[1] - a[1]\n        })\n      } else {\n        if (result.length > 41) {\n          result = result.slice(0, 41)\n        }\n        result.push([code, 1])\n      }\n      ConfigStorage.set({emojis_popular: result})\n    })\n  }\n\n  function indexEmojis () {\n    if (index === false) {\n      index = SearchIndexManager.createIndex()\n      var shortcut\n      for (shortcut in shortcuts) {\n        if (shortcuts.hasOwnProperty(shortcut)) {\n          SearchIndexManager.indexObject(shortcuts[shortcut], shortcut, index)\n        }\n      }\n    }\n  }\n\n  function searchEmojis (q) {\n    indexEmojis()\n    var foundObject = SearchIndexManager.search(q, index)\n    var foundCodes = []\n    var code\n    for (code in foundObject) {\n      if (foundObject.hasOwnProperty(code)) {\n        foundCodes.push(code)\n      }\n    }\n    return foundCodes\n  }\n\n  global.EmojiHelper = {\n    emojis: emojis,\n    shortcuts: shortcuts,\n    spritesheetPositions: spritesheetPositions,\n    getPopularEmoji: getPopularEmoji,\n    pushPopularEmoji: pushPopularEmoji,\n    indexEmojis: indexEmojis,\n    searchEmojis: searchEmojis\n  }\n})(window, Config.Emoji, Config.EmojiCategories, Config.EmojiCategorySpritesheetDimens)\n\nfunction EmojiTooltip (btnEl, options) {\n  options = options || {}\n  var self = this\n\n  this.btnEl = $(btnEl)\n  this.onEmojiSelected = options.onEmojiSelected\n  this.onStickerSelected = options.onStickerSelected\n  this.getStickers = options.getStickers\n  this.getStickerImage = options.getStickerImage\n  this.onStickersetSelected = options.onStickersetSelected\n  this.langpack = options.langpack || {}\n\n  if (!Config.Navigator.touch) {\n    $(this.btnEl).on('mouseenter mouseleave', function (e) {\n      self.isOverBtn = e.type == 'mouseenter'\n      self.createTooltip()\n\n      if (self.isOverBtn) {\n        self.onMouseEnter(true)\n      } else {\n        self.onMouseLeave(true)\n      }\n    })\n  }\n  $(this.btnEl).on('mousedown', function (e) {\n    if (!self.shown) {\n      clearTimeout(self.showTimeout)\n      delete self.showTimeout\n      self.createTooltip()\n      self.show()\n    } else {\n      clearTimeout(self.hideTimeout)\n      delete self.hideTimeout\n      self.hide()\n    }\n    return cancelEvent(e)\n  })\n  $(document).on('mousedown', function (e) {\n    if (self.shown) {\n      self.hide()\n    }\n  })\n}\n\nEmojiTooltip.prototype.onMouseEnter = function (triggerShow) {\n  if (this.hideTimeout) {\n    clearTimeout(this.hideTimeout)\n    delete this.hideTimeout\n  }\n  else if (triggerShow && !this.showTimeout) {\n    this.showTimeout = setTimeout(this.show.bind(this), 100)\n  }\n}\n\nEmojiTooltip.prototype.onMouseLeave = function (triggerUnshow) {\n  if (!this.hideTimeout) {\n    var self = this\n    this.hideTimeout = setTimeout(function () {\n      self.hide()\n    }, 600)\n  }\n  else if (triggerUnshow && this.showTimeout) {\n    clearTimeout(this.showTimeout)\n    delete this.showTimeout\n  }\n}\n\nEmojiTooltip.prototype.createTooltip = function () {\n  if (this.tooltipEl) {\n    return false\n  }\n\n  var html =\n  '<div class=\"composer_emoji_tooltip noselect\">\\\n  <div class=\"composer_emoji_tooltip_tabs\">\\\n    <div class=\"composer_emoji_tooltip_tab composer_emoji_tooltip_tab_emoji\">' + this.langpack.im_emoji_tab + '</div>\\\n    <div class=\"composer_emoji_tooltip_tab composer_emoji_tooltip_tab_stickers\">' + this.langpack.im_stickers_tab + '</div>\\\n    <div class=\"composer_emoji_tooltip_tab_shadow\"></div>\\\n  </div>\\\n  <div class=\"composer_emoji_tooltip_tabs_wrap\">\\\n    <div class=\"composer_emoji_tooltip_tabs_contents clearfix\">\\\n      <div class=\"composer_emoji_tooltip_tab_emoji_content\">\\\n        <div class=\"composer_emoji_tooltip_content_wrap\">\\\n          <div class=\"composer_emoji_tooltip_content composer_emoji_tooltip_content_emoji clearfix\"></div>\\\n        </div>\\\n        <div class=\"composer_emoji_tooltip_categories\">\\\n          <a class=\"composer_emoji_tooltip_category active\" data-category=\"0\"><i class=\"composer_emoji_tooltip_category_recent\"></i></a>\\\n          <a class=\"composer_emoji_tooltip_category\" data-category=\"1\"><i class=\"composer_emoji_tooltip_category_smile\"></i></a>\\\n          <a class=\"composer_emoji_tooltip_category\" data-category=\"2\"><i class=\"composer_emoji_tooltip_category_flower\"></i></a>\\\n          <a class=\"composer_emoji_tooltip_category\" data-category=\"3\"><i class=\"composer_emoji_tooltip_category_bell\"></i></a>\\\n          <a class=\"composer_emoji_tooltip_category\" data-category=\"4\"><i class=\"composer_emoji_tooltip_category_car\"></i></a>\\\n          <a class=\"composer_emoji_tooltip_category\" data-category=\"5\"><i class=\"composer_emoji_tooltip_category_grid\"></i></a>\\\n        </div>\\\n      </div>\\\n      <div class=\"composer_emoji_tooltip_tab_stickers_content\">\\\n        <div class=\"composer_emoji_tooltip_content_wrap\">\\\n            <div class=\"composer_emoji_tooltip_content composer_emoji_tooltip_content_stickers clearfix\"></div>\\\n          </div>\\\n          <div class=\"composer_emoji_tooltip_categories\"></div>\\\n      </div>\\\n    </div>\\\n  </div>\\\n  <div class=\"composer_emoji_tooltip_tail\"><i class=\"icon icon-tooltip-tail\"></i></div>\\\n</div>'\n\n  html = html.replace(/>\\s+</g, '><')\n\n  var self = this\n  this.tooltipEl = $(html).appendTo(document.body)\n\n  this.tabsEl = $('.composer_emoji_tooltip_tabs', this.tooltipEl)\n  this.categoriesEl = $('.composer_emoji_tooltip_categories', this.tooltipEl)\n  this.stickersCategoriesEl = $('.composer_emoji_tooltip_tab_stickers_content .composer_emoji_tooltip_categories', this.tooltipEl)\n\n  this.contentEl = $('.composer_emoji_tooltip_content', this.tooltipEl)\n  this.emojiContentEl = $('.composer_emoji_tooltip_content_emoji', this.tooltipEl)\n  this.stickersContentEl = $('.composer_emoji_tooltip_content_stickers', this.tooltipEl)\n\n  // Tabs\n  angular.forEach(['emoji', 'stickers'], function (tabName, tabIndex) {\n    var tab = $('.composer_emoji_tooltip_tab_' + tabName, self.tabsEl)\n      .on('mousedown', function (e) {\n        self.selectTab(tabIndex)\n        return cancelEvent(e)\n      })\n\n    if (!Config.Navigator.touch) {\n      tab.on('mouseenter mouseleave', function (e) {\n        clearTimeout(self.selectTabTimeout)\n        if (e.type == 'mouseenter') {\n          self.selectTabTimeout = setTimeout(function () {\n            self.selectTab(tabIndex)\n          }, 300)\n        }\n      })\n    }\n  })\n\n  // Categories\n  var handleEvents = 'mousedown'\n  if (!Config.Navigator.touch) {\n    handleEvents += ' mouseover mouseout'\n  }\n  this.categoriesEl.on(handleEvents, function (e) {\n    e = e.originalEvent || e\n    var target = e.target\n    if (target.tagName != 'A') {\n      target = target.parentNode\n    }\n    if (target.tagName != 'A') {\n      return\n    }\n    var catIndex = parseInt(target.getAttribute('data-category'))\n    if (e.type == 'mousedown') {\n      self.selectCategory(catIndex)\n      return cancelEvent(e)\n    }\n    if (self.tab) {\n      return\n    }\n    var isOver = e.type == 'mouseover'\n    if (isOver && self.selectCategoryIndex == catIndex) {\n      return\n    }\n    clearTimeout(self.selectCategoryTimeout)\n    delete self.selectCategoryTimeout\n    if (isOver) {\n      self.selectCategoryIndex = catIndex\n      self.selectCategoryTimeout = setTimeout(function () {\n        delete self.selectCategoryIndex\n        delete self.selectCategoryTimeout\n        self.selectCategory(catIndex)\n      }, 300)\n    } else {\n      delete self.selectCategoryIndex\n    }\n  })\n\n  this.emojiScroller = new Scroller(this.emojiContentEl, {classPrefix: 'composer_emoji_tooltip'})\n  this.stickersScroller = new Scroller(this.stickersContentEl, {classPrefix: 'composer_emoji_tooltip'})\n  this.stickersScroller.onScroll(function (el, st) {\n    self.onStickersScroll(el, st)\n  })\n\n  this.contentEl.on('mousedown', function (e) {\n    e = e.originalEvent || e\n    var target = $(e.target), code, sticker, stickerset\n    if (target[0].tagName != 'A') {\n      target = $(target[0].parentNode)\n    }\n    if (code = target.attr('data-code')) {\n      if (self.onEmojiSelected) {\n        self.onEmojiSelected(code)\n      }\n      EmojiHelper.pushPopularEmoji(code)\n    }\n    if (sticker = target.attr('data-sticker')) {\n      if (self.onStickerSelected) {\n        self.onStickerSelected(sticker)\n      }\n      if (Config.Mobile) {\n        self.hide()\n      }\n    }\n    if (stickerset = target.attr('data-stickerset')) {\n      if (self.onStickersetSelected) {\n        self.onStickersetSelected(stickerset)\n      }\n      self.hide()\n    }\n    return cancelEvent(e)\n  })\n\n  if (!Config.Navigator.touch) {\n    this.tooltipEl.on('mouseenter mouseleave', function (e) {\n      if (e.type == 'mouseenter') {\n        self.onMouseEnter()\n      } else {\n        self.onMouseLeave()\n      }\n    })\n  }\n\n  this.selectTab(0)\n\n  $(window).on('resize', this.updatePosition.bind(this))\n\n  return true\n}\n\nEmojiTooltip.prototype.selectCategory = function (cat, force) {\n  if (!this.tab && this.cat === cat && !force) {\n    return false\n  }\n  $('.active', this.categoriesEl).removeClass('active')\n  this.cat = cat\n\n  if (this.tab) {\n    this.activateStickerCategory()\n    this.updateStickersContents(force)\n  } else {\n    $(this.categoriesEl[this.tab].childNodes[cat]).addClass('active')\n    this.updateEmojiContents()\n  }\n}\n\nEmojiTooltip.prototype.selectTab = function (tab, force) {\n  if (this.tab === tab && !force) {\n    return false\n  }\n\n  this.tab = tab\n  this.selectCategory(0, true)\n\n  var self = this\n  setTimeout(function () {\n    $(self.tooltipEl).toggleClass('composer_emoji_tooltip_tabs_stickers_active', tab == 1)\n  }, 0)\n}\n\nEmojiTooltip.prototype.updateEmojiContents = function () {\n  var html = []\n  var self = this\n  var iconSize = 26\n\n  var renderContent = function () {\n    self.emojiContentEl.html(html.join(''))\n    self.emojiScroller.reinit()\n  }\n\n  if (this.cat > 0) {\n    var categoryIndex = this.cat - 1\n    var emoticonCodes = Config.EmojiCategories[categoryIndex]\n    var totalColumns = Config.EmojiCategorySpritesheetDimens[categoryIndex][1]\n    var count = emoticonCodes.length\n    var emoticonCode\n    var emoticonData\n    var i\n    var x\n    var y\n\n    for (i = 0; i < count; i++) {\n      emoticonCode = emoticonCodes[i]\n      emoticonData = Config.Emoji[emoticonCode]\n      x = iconSize * (i % totalColumns)\n      y = iconSize * Math.floor(i / totalColumns)\n      html.push('<a class=\"composer_emoji_btn\" title=\":' + encodeEntities(emoticonData[1][0]) + ':\" data-code=\"' + encodeEntities(emoticonCode) + '\"><i class=\"emoji emoji-w' + iconSize + ' emoji-spritesheet-' + categoryIndex + '\" style=\"background-position: -' + x + 'px -' + y + 'px;\"></i></a>')\n    }\n    renderContent()\n  }else {\n    EmojiHelper.getPopularEmoji(function (popularEmoji) {\n      var emoticonCode\n      var emoticonData\n      var spritesheet\n      var pos\n      var categoryIndex\n      var count = popularEmoji.length\n      var i\n      var x\n      var y\n\n      for (i = 0; i < count; i++) {\n        emoticonCode = popularEmoji[i].code\n        if (emoticonData = Config.Emoji[emoticonCode]) {\n          spritesheet = EmojiHelper.spritesheetPositions[emoticonCode]\n          categoryIndex = spritesheet[0]\n          pos = spritesheet[1]\n          x = iconSize * spritesheet[3]\n          y = iconSize * spritesheet[2]\n          html.push('<a class=\"composer_emoji_btn\" title=\":' + encodeEntities(emoticonData[1][0]) + ':\" data-code=\"' + encodeEntities(emoticonCode) + '\"><i class=\"emoji emoji-w' + iconSize + ' emoji-spritesheet-' + categoryIndex + '\" style=\"background-position: -' + x + 'px -' + y + 'px;\"></i></a>')\n        }\n      }\n      renderContent()\n    })\n  }\n}\n\nEmojiTooltip.prototype.updateStickersContents = function (force) {\n  var html = []\n  var categoriesHtml = []\n  var self = this\n  var iconSize = 26\n\n  var scrollStickers = function () {\n    var scrollTop = self.cat ? self.stickersetPositions[self.cat][0] : 0\n    self.stickersScroller.scrollTo(scrollTop, force ? 0 : 200)\n  }\n\n  if (!force && self.stickersetPositions.length) {\n    scrollStickers()\n    return\n  }\n\n  var renderStickers = function (stickersets) {\n    var set\n    var docID\n    var i\n    var j\n    var len1\n    var len2\n    for (i = 0, len1 = stickersets.length; i < len1; i++) {\n      set = stickersets[i]\n      if (!set.docIDs.length) {\n        continue\n      }\n      html.push('<div class=\"composer_stickerset_wrap clearfix\">')\n      if (set.title) {\n        html.push(\n          '<a class=\"composer_stickerset_title',\n          set.id ? '' : ' disabled',\n          '\" data-stickerset=\"',\n          encodeEntities(set.short_name),\n          '\">',\n          encodeEntities(set.title),\n          '</a>'\n        )\n      }\n      if (!set.id) {\n        categoriesHtml.push('<a class=\"composer_emoji_tooltip_category active\" data-category=\"0\"><i class=\"composer_emoji_tooltip_category_recent\"></i></a>')\n      } else {\n        categoriesHtml.push('<a class=\"composer_sticker_btn\" data-sticker=\"' + set.docIDs[0] + '\" data-category=\"' + i + '\"></a>')\n      }\n      for (j = 0, len2 = set.docIDs.length; j < len2; j++) {\n        docID = set.docIDs[j]\n        html.push('<a class=\"composer_sticker_btn\" data-sticker=\"' + docID + '\"></a>')\n      }\n      html.push('</div>')\n    }\n\n    self.stickersContentEl.html(html.join(''))\n    self.stickersCategoriesEl.html(categoriesHtml.join(''))\n    self.stickersScroller.reinit()\n\n    var scrollPositions = []\n    $('.composer_stickerset_wrap', self.stickersContentEl).each(function (k, stickerSetEl) {\n      var height = stickerSetEl.offsetHeight\n      var top = stickerSetEl.offsetTop\n      scrollPositions.push([top, height])\n    })\n    self.stickersetPositions = scrollPositions\n    scrollStickers()\n\n    var preload = []\n    self.contentEl.find('.composer_sticker_btn').each(function (k, element) {\n      if (k < 12) {\n        self.replaceStickerImage(element)\n      } else {\n        preload.push([element.offsetTop, element])\n      }\n    })\n    self.stickersPreload = preload\n\n    self.stickersCategoriesEl.find('.composer_sticker_btn').each(function (k, element) {\n      self.replaceStickerImage(element)\n    })\n  }\n  this.getStickers(renderStickers)\n}\n\nEmojiTooltip.prototype.replaceStickerImage = function (element) {\n  element = $(element)\n  this.getStickerImage(element, element.attr('data-sticker'))\n}\n\nEmojiTooltip.prototype.onStickersScroll = function (scrollable, scrollTop) {\n  var ch = scrollable.clientHeight\n  var sh = scrollable.scrollHeight\n  var len = this.stickersetPositions.length\n  var currentCat = false\n  var currentPos\n  var i\n\n  if (scrollTop < 20) {\n    currentCat = 0\n  } else if (scrollTop > sh - ch - 20) {\n    currentCat = len - 1\n  } else {\n    for (i = 0; i < len; i++) {\n      currentPos = this.stickersetPositions[i]\n      if (scrollTop >= currentPos[0] &&\n        scrollTop < (currentPos[0] + currentPos[1])) {\n        currentCat = i\n        break\n      }\n    }\n  }\n  var len = this.stickersPreload.length\n  if (len) {\n    for (i = 0; i < len; i++) {\n      currentPos = this.stickersPreload[i]\n      if (currentPos[0] >= scrollTop && currentPos[0] <= scrollTop + ch) {\n        // console.log('replace', currentPos[1], i)\n        this.replaceStickerImage(currentPos[1])\n        this.stickersPreload.splice(i, 1)\n        i--\n        len--\n      }\n    }\n  }\n  // console.log('on sticker scroll', scrollTop, ch, sh, currentCat, this.stickersetPositions)\n  if (this.cat === currentCat || currentCat === false) {\n    return\n  }\n  $('.active', this.categoriesEl).removeClass('active')\n  this.cat = currentCat\n  this.activateStickerCategory()\n}\n\nEmojiTooltip.prototype.onStickersChanged = function () {\n  if (this.tab) {\n    this.updateStickersContents(true)\n  }\n}\n\nEmojiTooltip.prototype.activateStickerCategory = function () {\n  var categoriesEl = this.categoriesEl[1]\n  var categoryEl = categoriesEl.childNodes[this.cat]\n  if (!categoryEl) {\n    return\n  }\n  $(categoryEl).addClass('active')\n\n  var left = categoryEl.offsetLeft\n  var width = categoryEl.offsetWidth\n  var viewportWidth = categoriesEl.clientWidth\n\n  // console.log('current cat el', categoryEl, left, width, viewportWidth)\n  $(categoriesEl).stop(true).animate({scrollLeft: left - (viewportWidth - width) / 2}, 200)\n}\n\nEmojiTooltip.prototype.updatePosition = function () {\n  var offset = this.btnEl.offset()\n  this.tooltipEl.css({top: offset.top, left: offset.left})\n}\n\nEmojiTooltip.prototype.show = function () {\n  this.updatePosition()\n  if (this.tab) {\n    this.updateStickersContents(true)\n  } else {\n    this.updateEmojiContents()\n  }\n  this.tooltipEl.addClass('composer_emoji_tooltip_shown')\n  this.btnEl.addClass('composer_emoji_insert_btn_on')\n  delete this.showTimeout\n  this.shown = true\n}\n\nEmojiTooltip.prototype.hide = function () {\n  if (this.tooltipEl) {\n    this.tooltipEl.removeClass('composer_emoji_tooltip_shown')\n    this.btnEl.removeClass('composer_emoji_insert_btn_on')\n  }\n  delete this.hideTimeout\n  delete this.shown\n}\n\nfunction EmojiPanel (containerEl, options) {\n  options = options || {}\n  var self = this\n\n  this.containerEl = $(containerEl)\n  this.onEmojiSelected = options.onEmojiSelected\n\n  this.containerEl.on('mousedown', function (e) {\n    e = e.originalEvent || e\n    var target = $(e.target), code\n    if (target[0].tagName != 'A') {\n      target = $(target[0].parentNode)\n    }\n    if (code = target.attr('data-code')) {\n      if (self.onEmojiSelected) {\n        self.onEmojiSelected(code)\n      }\n      EmojiHelper.pushPopularEmoji(code)\n    }\n    return cancelEvent(e)\n  })\n\n  this.update()\n}\n\nEmojiPanel.prototype.update = function () {\n  var html = []\n  var self = this\n  var iconSize = Config.Mobile ? 26 : 20\n\n  EmojiHelper.getPopularEmoji(function (popularEmoji) {\n    var emoticonCode\n    var emoticonData\n    var spritesheet\n    var pos\n    var categoryIndex\n    var count = popularEmoji.length\n    var i\n    var x\n    var y\n\n    for (i = 0; i < count; i++) {\n      emoticonCode = popularEmoji[i].code\n      if (emoticonData = Config.Emoji[emoticonCode]) {\n        spritesheet = EmojiHelper.spritesheetPositions[emoticonCode]\n        categoryIndex = spritesheet[0]\n        pos = spritesheet[1]\n        x = iconSize * spritesheet[3]\n        y = iconSize * spritesheet[2]\n        html.push('<a class=\"composer_emoji_btn\" title=\":' + encodeEntities(emoticonData[1][0]) + ':\" data-code=\"' + encodeEntities(emoticonCode) + '\"><i class=\"emoji emoji-w20 emoji-spritesheet-' + categoryIndex + '\" style=\"background-position: -' + x + 'px -' + y + 'px;\"></i></a>')\n      }\n    }\n    self.containerEl.html(html.join(''))\n  })\n}\n\nfunction MessageComposer (textarea, options) {\n  var self = this\n\n  this.textareaEl = $(textarea)\n\n  this.setUpInput()\n\n  this.autoCompleteWrapEl = $('<div class=\"composer_dropdown_wrap\"></div>').appendTo(document.body)\n  var autoCompleteEl = $('<div></div>').appendTo(this.autoCompleteWrapEl)\n\n  options.dropdownDirective(autoCompleteEl, function (scope, newAutoCompleteEl) {\n    self.autoCompleteEl = newAutoCompleteEl\n    self.autoCompleteScope = scope\n    self.setUpAutoComplete()\n  })\n\n  this.isActive = false\n\n  this.onTyping = options.onTyping\n  this.onMessageSubmit = options.onMessageSubmit\n  this.getSendOnEnter = options.getSendOnEnter\n  this.onFilePaste = options.onFilePaste\n  this.onCommandSend = options.onCommandSend\n  this.onInlineResultSend = options.onInlineResultSend\n  this.mentions = options.mentions\n  this.commands = options.commands\n}\n\nMessageComposer.autoCompleteRegEx = /(\\s|^)(:|@|\\/)([\\S]*)$/\n\nMessageComposer.prototype.setUpInput = function () {\n  this.inlinePlaceholderWrap = $('<div class=\"im_inline_placeholder_wrap\"></div>').prependTo(this.textareaEl[0].parentNode)\n  this.inlinePlaceholderPrefixEl = $('<span class=\"im_inline_placeholder_prefix\"></span>').appendTo(this.inlinePlaceholderWrap)\n  this.inlinePlaceholderEl = $('<span class=\"im_inline_placeholder\"></span>').appendTo(this.inlinePlaceholderWrap)\n\n  if ('contentEditable' in document.body) {\n    this.setUpRich()\n  } else {\n    this.setUpPlaintext()\n  }\n\n  if (!Config.Mobile) {\n    var sbWidth = getScrollWidth()\n    if (sbWidth) {\n      (this.richTextareaEl || this.textareaEl).css({marginRight: -sbWidth})\n    }\n  }\n}\n\nMessageComposer.prototype.setInlinePlaceholder = function (prefix, placeholder) {\n  this.inlinePlaceholderPrefix = prefix\n  this.inlinePlaceholderPrefixEl.html(encodeEntities(prefix))\n  this.inlinePlaceholderEl.html(encodeEntities(placeholder))\n  this.onChange()\n}\n\nMessageComposer.prototype.updateInlinePlaceholder = function () {\n  var prefix = this.inlinePlaceholderPrefix\n  if (prefix) {\n    var value = this.textareaEl.val()\n    this.inlinePlaceholderWrap.toggleClass('active', value == prefix)\n  }\n}\n\nMessageComposer.prototype.setUpAutoComplete = function () {\n  this.scroller = new Scroller(this.autoCompleteEl, {maxHeight: 180})\n\n  var self = this\n  this.autoCompleteEl.on('mousedown', function (e) {\n    e = e.originalEvent || e\n    var target = e.target\n    var mention\n    var code\n    var command\n    var inlineID\n    while (target && target.tagName != 'A') {\n      target = target.parentNode\n    }\n    if (!target) {\n      return cancelEvent(e)\n    }\n    target = $(target)\n    if (code = target.attr('data-code')) {\n      if (self.onEmojiSelected) {\n        self.onEmojiSelected(code, true)\n      }\n      EmojiHelper.pushPopularEmoji(code)\n    }\n    if (mention = target.attr('data-mention')) {\n      self.onMentionSelected(mention, target.attr('data-name'))\n    }\n    if (command = target.attr('data-command')) {\n      if (self.onCommandSelected) {\n        self.onCommandSelected(command)\n      }\n      self.hideSuggestions()\n    }\n    if (inlineID = target.attr('data-inlineid')) {\n      if (self.onInlineResultSend) {\n        self.onInlineResultSend(inlineID)\n      }\n      self.hideSuggestions()\n    }\n    return cancelEvent(e)\n  })\n}\n\nMessageComposer.prototype.setUpRich = function () {\n  this.textareaEl.hide()\n  this.richTextareaEl = $('<div class=\"composer_rich_textarea\" contenteditable=\"true\" dir=\"auto\"></div>')\n\n  this.textareaEl[0].parentNode.insertBefore(this.richTextareaEl[0], this.textareaEl[0])\n\n  this.richTextareaEl.on('keyup keydown', this.onKeyEvent.bind(this))\n  this.richTextareaEl.on('focus blur', this.onFocusBlur.bind(this))\n  this.richTextareaEl.on('paste', this.onRichPaste.bind(this))\n  this.richTextareaEl.on('DOMNodeInserted', this.onRichPasteNode.bind(this))\n\n  $(document.body).on('keydown', this.backupSelection.bind(this))\n}\n\nMessageComposer.prototype.setUpPlaintext = function () {\n  this.textareaEl.on('keyup keydown', this.onKeyEvent.bind(this))\n  this.textareaEl.on('focus blur', this.onFocusBlur.bind(this))\n}\n\nMessageComposer.prototype.onKeyEvent = function (e) {\n  var self = this\n  if (e.type == 'keyup') {\n    // console.log(dT(), 'keyup', e.keyCode)\n    this.checkAutocomplete()\n\n    var length = false\n    if (this.richTextareaEl) {\n      clearTimeout(this.updateValueTO)\n      var now = tsNow()\n      if (this.keyupStarted === undefined) {\n        this.keyupStarted = now\n      }\n      if (now - this.keyupStarted > 3000 || true) {\n        this.onChange()\n      }else {\n        length = this.richTextareaEl[0].textContent.length\n        if (this.wasEmpty != !length) {\n          this.wasEmpty = !this.wasEmpty\n          this.onChange()\n        } else if (this.inlinePlaceholderPrefix) {\n          this.onChange()\n        } else {\n          this.updateValueTO = setTimeout(this.onChange.bind(this), 1000)\n        }\n      }\n    }\n\n    if (this.onTyping) {\n      var now = tsNow()\n      if (now - this.lastTyping > 5000) {\n        if (length === false) {\n          length = (this.richTextareaEl ? this.richTextareaEl[0].textContent : this.textareaEl[0].value).length\n        }\n\n        if (length != this.lastLength) {\n          this.lastTyping = now\n          this.lastLength = length\n          this.onTyping()\n        }\n      }\n    }\n  }\n  if (e.type == 'keydown') {\n    var checkSubmit = !this.autocompleteShown\n    if (this.autocompleteShown) {\n      if (e.keyCode == 38 || e.keyCode == 40) { // UP / DOWN\n        var next = e.keyCode == 40\n        var currentSel = $(this.autoCompleteEl).find('li.composer_autocomplete_option_active')\n        var allLIs = Array.prototype.slice.call($(this.autoCompleteEl).find('li'))\n        var nextSel\n\n        if (currentSel.length) {\n          var pos = allLIs.indexOf(currentSel[0])\n          var nextPos = pos + (next ? 1 : -1)\n          nextSel = allLIs[nextPos]\n          currentSel.removeClass('composer_autocomplete_option_active')\n          if (nextSel) {\n            $(nextSel).addClass('composer_autocomplete_option_active')\n            this.scroller.scrollToNode(nextSel)\n            // console.log(dT(), 'keydown cancel', e.keyCode)\n            return cancelEvent(e)\n          }\n        }\n\n        nextSel = allLIs[next ? 0 : allLIs.length - 1]\n        this.scroller.scrollToNode(nextSel)\n        $(nextSel).addClass('composer_autocomplete_option_active')\n\n        // console.log(dT(), 'keydown cancel', e.keyCode)\n        return cancelEvent(e)\n      }\n\n      if (e.keyCode == 13 || e.keyCode == 9) { // Enter or Tab\n        var currentSel = $(this.autoCompleteEl).find('li.composer_autocomplete_option_active')\n        if (!currentSel.length && e.keyCode == 9) {\n          currentSel = $(this.autoCompleteEl).find('li:first')\n        }\n        currentSel = currentSel.find('a:first')\n        var code\n        var mention\n        var command\n        var inlineID\n        if (code = currentSel.attr('data-code')) {\n          this.onEmojiSelected(code, true)\n          EmojiHelper.pushPopularEmoji(code)\n          return cancelEvent(e)\n        }\n        if (mention = currentSel.attr('data-mention')) {\n          this.onMentionSelected(mention, currentSel.attr('data-name'))\n          return cancelEvent(e)\n        }\n        if (command = currentSel.attr('data-command')) {\n          if (this.onCommandSelected) {\n            this.onCommandSelected(command, e.keyCode == 9)\n          }\n          return cancelEvent(e)\n        }\n        if (inlineID = currentSel.attr('data-inlineid')) {\n          if (self.onInlineResultSend) {\n            self.onInlineResultSend(inlineID)\n          }\n          self.hideSuggestions()\n          // console.log(dT(), 'keydown cancel', e.keyCode)\n          return cancelEvent(e)\n        }\n        checkSubmit = true\n      }\n    }\n\n    if (checkSubmit && e.keyCode == 13) {\n      var submit = false\n      var sendOnEnter = true\n      if (this.getSendOnEnter && !this.getSendOnEnter()) {\n        sendOnEnter = false\n      }\n      if (sendOnEnter && !e.shiftKey) {\n        submit = true\n      } else if (!sendOnEnter && (e.ctrlKey || e.metaKey)) {\n        submit = true\n      }\n\n      if (submit) {\n        this.onMessageSubmit(e)\n        return cancelEvent(e)\n      }\n    }\n  }\n}\n\nMessageComposer.prototype.backupSelection = function () {\n  delete this.selection\n\n  if (!this.isActive) {\n    return\n  }\n  if (window.getSelection) {\n    var sel = window.getSelection()\n    if (sel.getRangeAt && sel.rangeCount) {\n      this.selection = sel.getRangeAt(0)\n    }\n  } else if (document.selection && document.selection.createRange) {\n    this.selection = document.selection.createRange()\n  }\n}\n\nMessageComposer.prototype.restoreSelection = function () {\n  if (!this.selection) {\n    return false\n  }\n  var result = false\n  if (window.getSelection) {\n    var sel = window.getSelection()\n    sel.removeAllRanges()\n    sel.addRange(this.selection)\n    result = true\n  }\n  else if (document.selection && this.selection.select) {\n    this.selection.select()\n    result = true\n  }\n  delete this.selection\n\n  return result\n}\n\nMessageComposer.prototype.checkAutocomplete = function (forceFull) {\n  var pos\n  var value\n  if (this.richTextareaEl) {\n    var textarea = this.richTextareaEl[0]\n    var valueCaret = getRichValueWithCaret(textarea)\n    var value = valueCaret[0]\n    var pos = valueCaret[1] >= 0 ? valueCaret[1] : value.length\n\n    if (!pos) {\n      this.cleanRichTextarea(value, true)\n    }\n  } else {\n    var textarea = this.textareaEl[0]\n    var pos = getFieldSelection(textarea)\n    var value = textarea.value\n  }\n\n  if (value &&\n    this.curInlineResults &&\n    this.curInlineResults.text == value) {\n    this.showInlineSuggestions(this.curInlineResults)\n    return\n  }\n\n  if (!forceFull) {\n    value = value.substr(0, pos)\n  }\n\n  var matches = value.match(MessageComposer.autoCompleteRegEx)\n  if (matches) {\n    if (this.previousQuery == matches[0]) {\n      return\n    }\n    this.previousQuery = matches[0]\n    var query = SearchIndexManager.cleanSearchText(matches[3])\n\n    if (matches[2] == '@') { // mentions\n      if (this.mentions && this.mentions.index) {\n        if (query.length) {\n          var foundObject = SearchIndexManager.search(query, this.mentions.index)\n          var foundUsers = []\n          var user\n          for (var i = 0, length = this.mentions.users.length; i < length; i++) {\n            user = this.mentions.users[i]\n            if (foundObject[user.id]) {\n              foundUsers.push(user)\n            }\n          }\n        } else {\n          var foundUsers = this.mentions.users\n        }\n        if (foundUsers.length) {\n          this.showMentionSuggestions(foundUsers)\n        } else {\n          this.hideSuggestions()\n        }\n      } else {\n        this.hideSuggestions()\n      }\n    }\n    else if (!matches[1] && matches[2] == '/') { // commands\n      if (this.commands && this.commands.index) {\n        if (query.length) {\n          var foundObject = SearchIndexManager.search(query, this.commands.index)\n          var foundCommands = []\n          var command\n          for (var i = 0, length = this.commands.list.length; i < length; i++) {\n            command = this.commands.list[i]\n            if (foundObject[command.value]) {\n              foundCommands.push(command)\n            }\n          }\n        } else {\n          var foundCommands = this.commands.list\n        }\n        if (foundCommands.length) {\n          this.showCommandsSuggestions(foundCommands)\n        } else {\n          this.hideSuggestions()\n        }\n      } else {\n        this.hideSuggestions()\n      }\n    }\n    else if (matches[2] == ':') { // emoji\n      EmojiHelper.getPopularEmoji((function (popular) {\n        if (query.length) {\n          var found = EmojiHelper.searchEmojis(query)\n          if (found.length) {\n            var popularFound = [],\n              code\n            var pos\n            for (var i = 0, len = popular.length; i < len; i++) {\n              code = popular[i].code\n              pos = found.indexOf(code)\n              if (pos >= 0) {\n                popularFound.push(code)\n                found.splice(pos, 1)\n                if (!found.length) {\n                  break\n                }\n              }\n            }\n            this.showEmojiSuggestions(popularFound.concat(found))\n          } else {\n            this.hideSuggestions()\n          }\n        } else {\n          this.showEmojiSuggestions(popular)\n        }\n      }).bind(this))\n    }\n  }else {\n    delete this.previousQuery\n    this.hideSuggestions()\n  }\n}\n\nMessageComposer.prototype.onFocusBlur = function (e) {\n  this.isActive = e.type == 'focus'\n\n  if (!this.isActive) {\n    this.cleanRichTextarea()\n    this.hideSuggestions()\n  } else {\n    setTimeout(this.checkAutocomplete.bind(this), 100)\n  }\n  if (this.richTextareaEl) {\n    document.execCommand('enableObjectResizing', !this.isActive, !this.isActive)\n  }\n}\n\nMessageComposer.prototype.onRichPaste = function (e) {\n  var cData = (e.originalEvent || e).clipboardData\n  var items = cData && cData.items || [],\n    i\n  for (i = 0; i < items.length; i++) {\n    if (items[i].kind == 'file') {\n      e.preventDefault()\n      return true\n    }\n  }\n\n  try {\n    var text = cData.getData('text/plain')\n  } catch (e) {\n    return true\n  }\n  setZeroTimeout(this.onChange.bind(this), 0)\n  if (text.length) {\n    document.execCommand('insertText', false, text)\n    return cancelEvent(e)\n  }\n  return true\n}\n\nMessageComposer.prototype.cleanRichTextarea = function (value, focused) {\n  if (!this.richTextareaEl[0]) {\n    return\n  }\n  if (value === undefined) {\n    value = getRichValue(this.richTextareaEl[0])\n  }\n  if (value.match(/^\\s*$/) && this.richTextareaEl.html().length > 0) {\n    this.richTextareaEl.html('')\n    this.lastLength = 0\n    this.wasEmpty = true\n\n    if (focused) {\n      var self = this\n      setZeroTimeout(function () {\n        self.focus()\n      })\n    }\n  }\n}\n\nMessageComposer.prototype.onRichPasteNode = function (e) {\n  var element = (e.originalEvent || e).target\n  var src = (element || {}).src || ''\n  var remove = false\n\n  if (src.substr(0, 5) == 'data:') {\n    remove = true\n    var blob = dataUrlToBlob(src)\n    this.onFilePaste(blob)\n    setZeroTimeout(function () {\n      element.parentNode.replaceChild(document.createTextNode('   '), element)\n    })\n  }\n  else if (src && !src.match(/img\\/blank\\.gif/)) {\n    var replacementNode = document.createTextNode(' ' + src + ' ')\n    setTimeout(function () {\n      element.parentNode.replaceChild(replacementNode, element)\n    }, 100)\n  }\n}\n\nMessageComposer.prototype.onEmojiSelected = function (code, autocomplete) {\n  if (this.richTextareaEl) {\n    var textarea = this.richTextareaEl[0]\n    if (!this.isActive) {\n      if (!this.restoreSelection()) {\n        setRichFocus(textarea)\n      }\n    }\n    if (autocomplete) {\n      var valueCaret = getRichValueWithCaret(textarea)\n      var fullValue = valueCaret[0]\n      var pos = valueCaret[1] >= 0 ? valueCaret[1] : fullValue.length\n      var suffix = fullValue.substr(pos)\n      var prefix = fullValue.substr(0, pos)\n      var matches = prefix.match(/:([\\S]*)$/)\n      var emoji = EmojiHelper.emojis[code]\n\n      var newValuePrefix\n      if (matches && matches[0]) {\n        newValuePrefix = prefix.substr(0, matches.index) + ':' + emoji[1] + ':'\n      } else {\n        newValuePrefix = prefix + ':' + emoji[1] + ':'\n      }\n      textarea.value = newValue\n\n      var html\n      if (suffix.length) {\n        this.selId = (this.selId || 0) + 1\n        html = this.getRichHtml(newValuePrefix) + '&nbsp;<span id=\"composer_sel' + this.selId + '\"></span>' + this.getRichHtml(suffix)\n        this.richTextareaEl.html(html)\n        setRichFocus(textarea, $('#composer_sel' + this.selId)[0])\n      } else {\n        html = this.getRichHtml(newValuePrefix) + '&nbsp;'\n        this.richTextareaEl.html(html)\n        setRichFocus(textarea)\n      }\n    } else {\n      var html = this.getEmojiHtml(code)\n      if (window.getSelection) {\n        var sel = window.getSelection()\n        if (sel.getRangeAt && sel.rangeCount) {\n          var el = document.createElement('div')\n          el.innerHTML = html\n          var node = el.firstChild\n          var range = sel.getRangeAt(0)\n          range.deleteContents()\n          range.insertNode(document.createTextNode(' '))\n          range.insertNode(node)\n          range.setStart(node, 0)\n\n          setTimeout(function () {\n            range = document.createRange()\n            range.setStartAfter(node)\n            range.collapse(true)\n            sel.removeAllRanges()\n            sel.addRange(range)\n          }, 0)\n        }\n      } else if (document.selection && document.selection.type != 'Control') {\n        document.selection.createRange().pasteHTML(html)\n      }\n    }\n  }else {\n    var textarea = this.textareaEl[0]\n    var fullValue = textarea.value\n    var pos = this.isActive ? getFieldSelection(textarea) : fullValue.length\n    var suffix = fullValue.substr(pos)\n    var prefix = fullValue.substr(0, pos)\n    var matches = autocomplete && prefix.match(/:([\\S]*)$/)\n    var emoji = EmojiHelper.emojis[code]\n\n    if (matches && matches[0]) {\n      var newValue = prefix.substr(0, matches.index) + ':' + emoji[1] + ': ' + suffix\n      var newPos = matches.index + emoji[1].length + 3\n    } else {\n      var newValue = prefix + ':' + emoji[1] + ': ' + suffix\n      var newPos = prefix.length + emoji[1].length + 3\n    }\n    textarea.value = newValue\n    setFieldSelection(textarea, newPos)\n  }\n\n  this.hideSuggestions()\n  this.onChange()\n}\n\nMessageComposer.prototype.onMentionsUpdated = function (username) {\n  delete this.previousQuery\n  if (this.isActive) {\n    this.checkAutocomplete()\n  }\n}\n\nMessageComposer.prototype.onMentionSelected = function (username, firstName) {\n  var hasUsername = true;\n  if (username.charAt(0) == '#') {\n    hasUsername = false;\n    username = username.substr(1);\n    firstName = firstName.replace(/\\(\\)@/, '')\n  }\n\n  if (this.richTextareaEl) {\n    var textarea = this.richTextareaEl[0]\n    if (!this.isActive) {\n      if (!this.restoreSelection()) {\n        setRichFocus(textarea)\n      }\n    }\n    var valueCaret = getRichValueWithCaret(textarea)\n    var fullValue = valueCaret[0]\n    var pos = valueCaret[1] >= 0 ? valueCaret[1] : fullValue.length\n    var suffix = fullValue.substr(pos)\n    var prefix = fullValue.substr(0, pos)\n    var matches = prefix.match(/@([\\S]*)$/)\n\n    var newValuePrefix\n    if (matches && matches[0]) {\n      newValuePrefix = prefix.substr(0, matches.index) + '@' + username\n    } else {\n      newValuePrefix = prefix + '@' + username\n    }\n\n    var html\n    if (hasUsername) {\n      if (suffix.length) {\n        this.selId = (this.selId || 0) + 1\n        html = this.getRichHtml(newValuePrefix) + '&nbsp;<span id=\"composer_sel' + this.selId + '\"></span>' + this.getRichHtml(suffix)\n        this.richTextareaEl.html(html)\n        setRichFocus(textarea, $('#composer_sel' + this.selId)[0])\n      } else {\n        html = this.getRichHtml(newValuePrefix) + '&nbsp;'\n        this.richTextareaEl.html(html)\n        setRichFocus(textarea)\n      }\n    } else {\n      this.selId = (this.selId || 0) + 1\n      html = this.getRichHtml(newValuePrefix) + '&nbsp;(<span id=\"composer_sel' + this.selId + '\">' + encodeEntities(firstName) + '</span>)&nbsp;' + this.getRichHtml(suffix)\n      this.richTextareaEl.html(html)\n      setRichFocus(textarea, $('#composer_sel' + this.selId)[0], true)\n    }\n  } else {\n    var textarea = this.textareaEl[0]\n    var fullValue = textarea.value\n    var pos = this.isActive ? getFieldSelection(textarea) : fullValue.length\n    var suffix = fullValue.substr(pos)\n    var prefix = fullValue.substr(0, pos)\n    var matches = prefix.match(/@([\\S]*)$/)\n\n    var newValuePrefix\n    var newValue\n    var newPos\n    var newPosTo\n    if (matches && matches[0]) {\n      newValuePrefix = prefix.substr(0, matches.index) + '@' + username\n    } else {\n      newValuePrefix = prefix + '@' + username\n    }\n\n    if (hasUsername) {\n      newValue = newValuePrefix + '@' + username + ' ' + suffix\n      newPos = matches.index + username.length + 2\n    } else {\n      newValue = newValuePrefix + '@' + username + ' (' + firstName + ') ' + suffix\n      newPos = matches.index + username.length + 2\n      newPosTo = newPos + firstName.length\n    }\n    textarea.value = newValue\n    setFieldSelection(textarea, newPos, newPosTo)\n  }\n\n  this.hideSuggestions()\n  this.onChange()\n}\n\nMessageComposer.prototype.onCommandSelected = function (command, isTab) {\n  if (isTab) {\n    if (this.richTextareaEl) {\n      this.richTextareaEl.html(encodeEntities(command) + '&nbsp;')\n      setRichFocus(this.richTextareaEl[0])\n    }else {\n      var textarea = this.textareaEl[0]\n      textarea.value = command + ' '\n      setFieldSelection(textarea)\n    }\n  } else {\n    this.onCommandSend(command)\n  }\n\n  this.hideSuggestions()\n  this.onChange()\n}\n\nMessageComposer.prototype.onChange = function (e) {\n  if (this.richTextareaEl) {\n    delete this.keyupStarted\n    var richValue = getRichValue(this.richTextareaEl[0])\n    this.textareaEl.val(richValue).trigger('change')\n  }\n  this.updateInlinePlaceholder()\n}\n\nMessageComposer.prototype.getEmojiHtml = function (code, emoji) {\n  emoji = emoji || EmojiHelper.emojis[code]\n  var iconSize = 20\n  var spritesheet = EmojiHelper.spritesheetPositions[code]\n  var categoryIndex = spritesheet[0]\n  var pos = spritesheet[1]\n  var x = iconSize * spritesheet[3]\n  var y = iconSize * spritesheet[2]\n\n  return '<img src=\"img/blank.gif\" alt=\":' + encodeEntities(emoji[1]) + ':\" data-code=\"' + encodeEntities(code) + '\" class=\"emoji emoji-w20 emoji-spritesheet-' + categoryIndex + '\" style=\"background-position: -' + x + 'px -' + y + 'px;\" onresizestart=\"return false\" />'\n}\n\nMessageComposer.prototype.setValue = function (text) {\n  if (this.richTextareaEl) {\n    this.richTextareaEl.html(this.getRichHtml(text))\n    this.lastLength = text.length\n    this.wasEmpty = !text.length\n    this.onKeyEvent({type: 'keyup'})\n  } else {\n    this.textareaEl.val(text)\n  }\n}\n\nMessageComposer.prototype.setFocusedValue = function (parts) {\n  var prefix = parts[0]\n  var selection = parts[1]\n  var suffix = parts[2]\n\n  if (this.richTextareaEl) {\n    this.selId = (this.selId || 0) + 1\n    var html =\n    this.getRichHtml(prefix) +\n    '<span id=\"composer_sel' + this.selId + '\">' +\n    this.getRichHtml(selection) +\n    '</span>' +\n    this.getRichHtml(suffix)\n\n    this.richTextareaEl.html(html)\n\n    setRichFocus(this.richTextareaEl[0], $('#composer_sel' + this.selId)[0], true)\n  } else {\n    this.textareaEl.val(prefix + selection + suffix)\n    setFieldSelection(this.textareaEl[0], prefix.length, prefix.length + selection.length)\n  }\n}\n\nMessageComposer.prototype.getRichHtml = function (text) {\n  var html = $('<div>').text(text).html()\n  html = html.replace(/\\n/g, '<br/>')\n  html = html.replace(/:([A-Za-z0-9\\-\\+\\*_]+?):/gi, (function (all, shortcut) {\n    var code = EmojiHelper.shortcuts[shortcut]\n    if (code !== undefined) {\n      return this.getEmojiHtml(code)\n    }\n    return all\n  }).bind(this))\n  html = html.replace(/  /g, ' \\u00A0').replace(/^ | $/g, '\\u00A0')\n\n  return html\n}\n\nMessageComposer.prototype.focus = function () {\n  if (this.richTextareaEl) {\n    setZeroTimeout((function () {\n      setRichFocus(this.richTextareaEl[0])\n    }).bind(this))\n  } else {\n    setFieldSelection(this.textareaEl[0])\n  }\n}\n\nMessageComposer.prototype.blur = function () {\n  if (this.richTextareaEl) {\n    this.richTextareaEl[0].blur()\n  } else {\n    this.textareaEl[0].blur()\n  }\n}\n\nMessageComposer.prototype.renderSuggestions = function () {\n  this.autoCompleteWrapEl.show()\n  this.scroller.reinit()\n  this.updatePosition()\n  this.autocompleteShown = true\n}\n\nMessageComposer.prototype.showEmojiSuggestions = function (codes) {\n  var self = this\n  setZeroTimeout(function () {\n    self.autoCompleteScope.$apply(function () {\n      self.autoCompleteScope.type = 'emoji'\n      self.autoCompleteScope.emojiCodes = codes\n    })\n    onContentLoaded(function () {\n      self.renderSuggestions()\n    })\n  })\n}\n\nMessageComposer.prototype.showMentionSuggestions = function (users) {\n  var self = this\n  setZeroTimeout(function () {\n    self.autoCompleteScope.$apply(function () {\n      self.autoCompleteScope.type = 'mentions'\n      self.autoCompleteScope.mentionUsers = users\n    })\n    onContentLoaded(function () {\n      self.renderSuggestions()\n    })\n  })\n}\n\nMessageComposer.prototype.showCommandsSuggestions = function (commands) {\n  var self = this\n  setZeroTimeout(function () {\n    self.autoCompleteScope.$apply(function () {\n      self.autoCompleteScope.type = 'commands'\n      self.autoCompleteScope.commands = commands\n    })\n    onContentLoaded(function () {\n      self.renderSuggestions()\n    })\n  })\n}\n\nMessageComposer.prototype.showInlineSuggestions = function (botResults) {\n  if (!botResults || !botResults.results.length) {\n    this.hideSuggestions()\n    return\n  }\n  var self = this\n  if (self.autoCompleteScope.type == 'inline' &&\n    self.autoCompleteScope.botResults == botResults &&\n    self.autocompleteShown) {\n    return\n  }\n  setZeroTimeout(function () {\n    self.autoCompleteScope.$apply(function () {\n      self.autoCompleteScope.type = 'inline'\n      self.autoCompleteScope.botResults = botResults\n    })\n    onContentLoaded(function () {\n      self.renderSuggestions()\n    })\n  })\n}\n\nMessageComposer.prototype.setInlineSuggestions = function (botResults) {\n  this.curInlineResults = botResults\n  this.checkAutocomplete()\n}\n\nMessageComposer.prototype.updatePosition = function () {\n  var offset = (this.richTextareaEl || this.textareaEl).offset()\n  var height = this.scroller.updateHeight()\n  var width = $((this.richTextareaEl || this.textareaEl)[0].parentNode).outerWidth()\n  this.autoCompleteWrapEl.css({\n    top: offset.top - height,\n    left: Config.Mobile ? 0 : offset.left,\n    width: Config.Mobile ? '100%' : width - 2\n  })\n  this.scroller.update()\n}\n\nMessageComposer.prototype.hideSuggestions = function () {\n  // console.trace()\n  // return\n  this.autoCompleteWrapEl.hide()\n  delete this.autocompleteShown\n}\n\nMessageComposer.prototype.resetTyping = function () {\n  this.lastTyping = 0\n  this.lastLength = 0\n}\n\nMessageComposer.prototype.setPlaceholder = function (newPlaceholder) {\n  (this.richTextareaEl || this.textareaEl).attr('placeholder', newPlaceholder)\n}\n\nfunction Scroller (content, options) {\n  options = options || {}\n  var classPrefix = options.classPrefix || 'scroller'\n\n  this.content = $(content)\n  this.useNano = options.nano !== undefined ? options.nano : !Config.Mobile\n  this.maxHeight = options.maxHeight\n  this.minHeight = options.minHeight\n\n  if (this.useNano) {\n    this.setUpNano()\n  } else {\n    this.setUpNative()\n  }\n  this.updateHeight()\n}\nScroller.prototype.setUpNano = function () {\n  this.content.wrap('<div class=\"scroller_scrollable_container\"><div class=\"scroller_scrollable_wrap nano\"><div class=\"scroller_scrollable nano-content \"></div></div></div>')\n\n  this.scrollable = $(this.content[0].parentNode)\n  this.scroller = $(this.scrollable[0].parentNode)\n  this.wrap = $(this.scroller[0].parentNode)\n\n  this.scroller.nanoScroller({preventPageScrolling: true, tabIndex: -1})\n}\n\nScroller.prototype.setUpNative = function () {\n  this.content.wrap('<div class=\"scroller_native_scrollable\"></div>')\n  this.scrollable = $(this.content[0].parentNode)\n\n  this.scrollable.css({overflow: 'auto'})\n  if (this.maxHeight) {\n    this.scrollable.css({maxHeight: this.maxHeight})\n  }\n  if (this.minHeight) {\n    this.scrollable.css({minHeight: this.minHeight})\n  }\n}\n\nScroller.prototype.onScroll = function (cb) {\n  var self = this\n  var scrollable = this.scrollable[0]\n  this.scrollable.on('scroll', function (e) {\n    if (self.isAnimatedScroll) {\n      return\n    }\n    cb(scrollable, scrollable.scrollTop)\n  })\n}\n\nScroller.prototype.update = function () {\n  if (this.useNano) {\n    $(this.scroller).nanoScroller()\n  }\n}\n\nScroller.prototype.reinit = function () {\n  this.scrollTo(0)\n  if (this.useNano) {\n    setTimeout((function () {\n      this.updateHeight()\n    }).bind(this), 100)\n  }\n}\n\nScroller.prototype.updateHeight = function () {\n  var height\n  if (this.useNano) {\n    if (this.maxHeight || this.minHeight) {\n      height = this.content[0].offsetHeight\n      if (this.maxHeight && height > this.maxHeight) {\n        height = this.maxHeight\n      }\n      if (this.minHeight && height < this.minHeight) {\n        height = this.minHeight\n      }\n      this.wrap.css({height: height})\n    } else {\n      height = this.scroller[0].offsetHeight\n    }\n    $(this.scroller).nanoScroller()\n  } else {\n    height = this.scrollable[0].offsetHeight\n  }\n  return height\n}\n\nScroller.prototype.scrollTo = function (scrollTop, animation, cb) {\n  if (animation > 0) {\n    var self = this\n    this.isAnimatedScroll = true\n    this.scrollable.animate({scrollTop: scrollTop}, animation, function () {\n      delete self.isAnimatedScroll\n      if (self.useNano) {\n        $(self.scroller).nanoScroller({flash: true})\n      }\n      self.scrollable.trigger('scroll')\n      if (cb) {\n        cb()\n      }\n    })\n  } else {\n    this.scrollable[0].scrollTop = scrollTop\n    if (this.useNano) {\n      $(this.scroller).nanoScroller({flash: true})\n    }\n    if (cb) {\n      cb()\n    }\n  }\n}\n\nScroller.prototype.scrollToNode = function (node) {\n  node = node[0] || node\n  var elTop = node.offsetTop - 15\n  var elHeight = node.offsetHeight + 30\n  var scrollTop = this.scrollable[0].scrollTop\n  var viewportHeight = this.scrollable[0].clientHeight\n\n  if (scrollTop > elTop) { // we are below the node to scroll\n    this.scrollTo(elTop)\n  }\n  else if (scrollTop < elTop + elHeight - viewportHeight) { // we are over the node to scroll\n    this.scrollTo(elTop + elHeight - viewportHeight)\n  }\n}\n"]}